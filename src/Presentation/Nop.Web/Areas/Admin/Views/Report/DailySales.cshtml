@model DailySalesProductSearchModel

@{
    //page title
    ViewBag.PageTitle = T("Admin.Reports.DailySales").Text;
    NopHtml.SetActiveMenuItemSystemName("Daily Sales");
}

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@*we remove the default InputTagHelper to prevent the checkbox duplicating: https://stackoverflow.com/questions/42544961/asp-net-core-custom-input-tag-helper-rendering-duplicate-checkboxes*@
@removeTagHelper Microsoft.AspNetCore.Mvc.TagHelpers.InputTagHelper, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Nop.Web.Framework
@addTagHelper *, MiniProfiler.AspNetCore.Mvc

@{
    const string hideSearchBlockAttributeName = "LowStockPage.HideSearchBlock";
    var hideSearchBlock = await genericAttributeService.GetAttributeAsync<bool>(await workContext.GetCurrentCustomerAsync(), hideSearchBlockAttributeName);
}

<form asp-controller="Report" asp-action="DailySales" method="post">
    <div class="content-header clearfix">
        <h1 class="float-left">
            Daily Sales
        </h1>
        <div class="float-right">
            &nbsp;
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <div class="form-horizontal">
                <div class="cards-group">
                    <div class="card card-default card-search">
                        <div class="card-body">
                            <div class="row search-row @(!hideSearchBlock ? "opened" : "")" data-hideAttribute="@hideSearchBlockAttributeName">
                                <div class="search-text">@T("Search")</div>
                                <div class="icon-search"><i class="fas fa-search" aria-hidden="true"></i></div>
                                <div class="icon-collapse"><i class="far fa-angle-@(!hideSearchBlock ? "up" : "down")" aria-hidden="true"></i></div>
                            </div>

                            <div class="search-body @(hideSearchBlock ? "closed" : "")">
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="form-group row">
                                            <div class="col-md-4">
                                                <nop-label asp-for="Date" />
                                            </div>
                                            <div class="col-md-8">
                                                <nop-editor asp-for="Date" />
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <div class="col-md-4">
                                                <nop-label asp-for="VendorId" />
                                            </div>
                                            <div class="col-md-8">
                                                <nop-select asp-for="VendorId" asp-items="Model.AvailableVendors" />
                                            </div>
                                        </div>

                                        <div class="form-group row" @(Model.IsLoggedInAsVendor ? Html.Raw("style='display: none;'") : null)>
                                            <div class="col-md-4">
                                                <nop-label asp-for="OrderType" />
                                            </div>
                                            <div class="col-md-8">
                                                <nop-select asp-for="OrderType" asp-items="Model.AvailableOrderType" />
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <div class="col-md-4">
                                                <nop-label asp-for="ProductId" />
                                            </div>
                                            <div class="col-md-8">
                                                <input type="text" id="search-product-name" autocomplete="off" class="form-control" />
                                                <span id="search-product-friendly-name"></span>
                                                <button type="button" id="search-product-clear" class="btn bg-gray" style="display: none; margin-top: 5px;">@T("Admin.Common.Clear")</button>
                                                <input asp-for="ProductId" autocomplete="off" style="display: none;" />

                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8 offset-md-4">
                                            <button type="button" id="search-products" class="btn btn-primary btn-search">
                                                <i class="fas fa-search"></i>
                                                @T("Admin.Common.Search")
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="card card-default">
                            <div class="card-body">
                                <nop-doc-reference asp-string-resource="@T("Admin.Documentation.Reference.Reports", Docs.Reports + Utm.OnAdmin)" />
                                @await Html.PartialAsync("Table", new DataTablesModel
                                {
                                Name = "products-grid",

                                UrlRead = new DataUrl("DailySalesList", "Report", null),
                                SearchButtonId = "search-products",
                                Length = Model.PageSize,
                                LengthMenu = Model.AvailablePageSizes,


                                Filters = new List<FilterParameter>
                                {
                                new FilterParameter(nameof(Model.VendorId)),
                                new FilterParameter(nameof(Model.ProductId)),
                                new FilterParameter(nameof(Model.Date)),
                                new FilterParameter(nameof(Model.OrderType))
                                },
                                ColumnCollection = new List<ColumnProperty>
                                {
                                new ColumnProperty(nameof(DailySalesProductModel.FormattedDate))
                                {
                                Title = "Date",
                                Width = "150"
                                },
                                new ColumnProperty(nameof(DailySalesProductModel.OrderId))
                                {
                                Title = "OrderID",
                                Width = "150"
                                },
                                new ColumnProperty(nameof(DailySalesProductModel.Name))
                                {
                                Title = "ProductName",
                                Width = "300"
                                },
                                //new ColumnProperty(nameof(DailySalesProductModel.ProductId))
                                //{
                                //Title = "ProductID",
                                //Width = "150"
                                //},
                                new ColumnProperty(nameof(DailySalesProductModel.VendorId))
                                {
                                Title = "VendorID",
                                Width = "150"
                                },
                                new ColumnProperty(nameof(DailySalesProductModel.Quantity))
                                {
                                Title = "Quantity",
                                Width = "150"
                                },
                                new ColumnProperty(nameof(DailySalesProductModel.OriginalProductCost))
                                {
                                Title = "PurchasePrice",
                                Width = "100"
                                },
                                new ColumnProperty(nameof(DailySalesProductModel.Price))
                                {
                                Title = "SellingPrice",
                                Width = "100"
                                },
                                new ColumnProperty(nameof(DailySalesProductModel.PriceDifference))
                                {
                                Title = "Profit / Loss",
                                Width = "100"
                                }
                                }
                                })

                                <script asp-location="Footer">
                                    function renderColumnName(data, type, row, meta) {
                                        var textRenderer = $.fn.dataTable.render.text().display;
                                        var res = data;
                                        if (row.Attributes !== null) {
                                            return textRenderer(res) + '<div><i>' + textRenderer(row.Attributes) + '</i></div>';
                                        }
                                        else {
                                            return textRenderer(res);
                                        }
                                    }
                                </script>



                                <script>
                                    $(document).ready(function () {
                                        $('#search-product-name').autocomplete({
                                            delay: 500,
                                            minLength: 3,
                                            source: '@Url.Action("SearchAutoComplete", "SearchComplete")',
                                            select: function (event, ui) {
                                                $('#@Html.IdFor(model => model.ProductId)').val(ui.item.productid);
                                                $('#search-product-friendly-name').text(ui.item.label);

                                                $('#search-product-clear').show();
                                                return false;
                                            }
                                        });

                                        //remove button
                                        $('#search-product-clear').click(function () {
                                            $('#@Html.IdFor(model => model.ProductId)').val('0');
                                            $('#search-product-friendly-name').text('');
                                            $('#search-product-clear').hide();
                                            return false;
                                        });
                                    });
                                </script>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </section>
</form>